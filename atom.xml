<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Michael的技术探索与点滴记录~</title>
  
  <subtitle>Michael&#39;s Pages</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://coder-michael.tk/"/>
  <updated>2019-05-05T09:07:54.011Z</updated>
  <id>http://coder-michael.tk/</id>
  
  <author>
    <name>Michael Wu</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>GitLab升级和数据迁移方案</title>
    <link href="http://coder-michael.tk/2019/05/05/GitLab/Gitlab%E5%8D%87%E7%BA%A7%E5%92%8C%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB%E6%96%B9%E6%A1%88/"/>
    <id>http://coder-michael.tk/2019/05/05/GitLab/Gitlab升级和数据迁移方案/</id>
    <published>2019-05-05T10:04:47.473Z</published>
    <updated>2019-05-05T09:07:54.011Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>不管是GitLab升级还是GitLab数据迁移，在实施之前我都必须要先做好Gitlab数据备份工作。</p></blockquote><p>我们先来看看如何做GitLab的数据备份与恢复。GitLab自身提供了数据备份和恢复的工具:gitlab-rake,具体使用见下文：</p><h2 id="GitLab的数据备份与恢复"><a href="#GitLab的数据备份与恢复" class="headerlink" title="GitLab的数据备份与恢复"></a>GitLab的数据备份与恢复</h2><p>GitLab自身提供了数据备份和恢复的工具:gitlab-rake,具体使用见下文：</p><h3 id="GitLab备份配置"><a href="#GitLab备份配置" class="headerlink" title="GitLab备份配置"></a>GitLab备份配置</h3><p>GitLab默认的备份目录是：<code>/var/opt/gitlab/backups/</code>，建议选择一个空间充足的目录进行配置。我们可以通过修改<code>/etc/gitlab/gitlab.rb</code>文件中的如下内容来调整备份路径:</p><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 备份目录</span><br><span class="line">gitlab_rails[&apos;backup_path&apos;] = &quot;/var/opt/gitlab/backups&quot;</span><br><span class="line"># 备份文件保留时间，单位：秒</span><br><span class="line">gitlab_rails[&apos;backup_keep_time&apos;] = 604800</span><br></pre></td></tr></table></figure><h3 id="GitLab数据备份"><a href="#GitLab数据备份" class="headerlink" title="GitLab数据备份"></a>GitLab数据备份</h3><h4 id="1-备份命令"><a href="#1-备份命令" class="headerlink" title="1. 备份命令"></a>1. 备份命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/gitlab/bin/gitlab-rake gitlab:backup:create CRON=1</span><br></pre></td></tr></table></figure><p>备份操作比较简单，实际备份的数据会包含：数据库脚本、代码仓库、wiki、大文件、ssh用户秘钥等数据。<code>An application data backup creates an archive file that contains the database,all repositories and all attachments.</code>  </p><h4 id="2-备份文件"><a href="#2-备份文件" class="headerlink" title="2. 备份文件"></a>2. 备份文件</h4><p>执行完备份命令后的备份数据是这样的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node00 backups]# ll</span><br><span class="line">total 127632268</span><br><span class="line">-rw------- 1 git git 43414650880 Nov 27 00:10 1543247502_2018_11_26_gitlab_backup.tar</span><br><span class="line">-rw------- 1 git git 43630172160 Nov 28 00:14 1543334067_2018_11_27_gitlab_backup.tar</span><br><span class="line">-rw------- 1 git git 43650590720 Nov 29 00:16 1543420454_2018_11_28_gitlab_backup.tar</span><br></pre></td></tr></table></figure></p><h3 id="GitLab数据恢复"><a href="#GitLab数据恢复" class="headerlink" title="GitLab数据恢复"></a>GitLab数据恢复</h3><h4 id="1-恢复命令"><a href="#1-恢复命令" class="headerlink" title="1.恢复命令"></a>1.恢复命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-rake gitlab:backup:restore BACKUP=备份文件编号</span><br></pre></td></tr></table></figure><h4 id="2-恢复步骤"><a href="#2-恢复步骤" class="headerlink" title="2.恢复步骤"></a>2.恢复步骤</h4><h5 id="a-确保备份和恢复的GitLab应用版本相同"><a href="#a-确保备份和恢复的GitLab应用版本相同" class="headerlink" title="a. 确保备份和恢复的GitLab应用版本相同"></a>a. 确保备份和恢复的GitLab应用版本相同</h5><blockquote><p>GitLab数据恢复需要确保新服务器上的GitLab的版本必须与创建备份时的Gitlab版本号相同. 比如新服务器安装的是9.1.2版本的GitLab, 那么迁移之前, 最好将旧服务器的GitLab 升级为9.1.2再进行备份.</p></blockquote><h5 id="b-copy旧服务器上面的备份文件到新服务器"><a href="#b-copy旧服务器上面的备份文件到新服务器" class="headerlink" title="b. copy旧服务器上面的备份文件到新服务器"></a>b. copy旧服务器上面的备份文件到新服务器</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># scp用法</span><br><span class="line">scp 用户名@IP: 文件名1 远程用户名@IP: 文件名2</span><br><span class="line"># scp</span><br><span class="line">scp root@node00:/var/opt/gitlab/backups/1543420454_2018_11_28_gitlab_backup.tar .</span><br></pre></td></tr></table></figure><h5 id="c-恢复步骤"><a href="#c-恢复步骤" class="headerlink" title="c. 恢复步骤"></a>c. 恢复步骤</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># 1. 先赋权</span><br><span class="line">[root@node01 backups]# pwd</span><br><span class="line">/apps/dbdat/gitlab/backups</span><br><span class="line">[root@node01 backups]# chown git.root /apps/dbdat/gitlab/backups</span><br><span class="line">[root@node01 gitlab]# chmod 700 /apps/dbdat/gitlab/backups</span><br><span class="line">[root@node01 gitlab]# ll /apps/dbdat/gitlab/</span><br><span class="line">total 8</span><br><span class="line">drwx------ 2 git root 4096 Nov 29 10:30 backups</span><br><span class="line">[root@node01 backups]# chown git.git 1543334067_2018_11_27_gitlab_backup.tar </span><br><span class="line">[root@node01 backups]# chmod 600 1543334067_2018_11_27_gitlab_backup.tar </span><br><span class="line">[root@node01 backups]# ll</span><br><span class="line">total 42607596</span><br><span class="line">-rw------- 1 git git 43630172160 Nov 28 00:14 1543334067_2018_11_27_gitlab_backup.tar</span><br><span class="line"># 2. 执行恢复前，停止GitLab与数据库的连接，保留其他进程。</span><br><span class="line">[root@node01 backups]# gitlab-ctl stop unicorn</span><br><span class="line">[root@node01 backups]# gitlab-ctl stop sidekiq</span><br><span class="line"># Verify</span><br><span class="line">[root@node01 backups]# gitlab-ctl status</span><br><span class="line"></span><br><span class="line"># 3. 执行恢复命令</span><br><span class="line">[root@node01 backups]# gitlab-rake gitlab:backup:restore BACKUP=1543334067_2018_11_27</span><br><span class="line">Unpacking backup ... done</span><br><span class="line">Before restoring the database we recommend removing all existing</span><br><span class="line">tables to avoid future upgrade problems. Be aware that if you have</span><br><span class="line">custom tables in the GitLab database these tables and all data will be</span><br><span class="line">removed.</span><br><span class="line"></span><br><span class="line">Do you want to continue (yes/no)? yes</span><br><span class="line">Removing all tables. Press `Ctrl-C` within 5 seconds to abort</span><br><span class="line">...</span><br><span class="line"># 后面一路yes，覆盖数据库、覆盖仓库、生成sshkey</span><br><span class="line"># </span><br><span class="line"># 恢复完成后要记得重启Gitlab</span><br><span class="line">[root@node01 backups]# gitlab-ctl restart</span><br></pre></td></tr></table></figure><h2 id="GitLab版本升级"><a href="#GitLab版本升级" class="headerlink" title="GitLab版本升级"></a>GitLab版本升级</h2><blockquote><p>建议升级前按照钱数备份方式，先对GitLab数据进行备份，同时备份GitLab配置文件<code>/etc/gitlab/gitlab.rb</code>,然后再执行下列步骤。</p></blockquote><h3 id="1-关闭部分GitLab服务"><a href="#1-关闭部分GitLab服务" class="headerlink" title="1. 关闭部分GitLab服务"></a>1. 关闭部分GitLab服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl stop unicorn</span><br><span class="line">gitlab-ctl stop sidekiq</span><br><span class="line">gitlab-ctl stop nginx</span><br></pre></td></tr></table></figure><h3 id="2-升级GitLab"><a href="#2-升级GitLab" class="headerlink" title="2. 升级GitLab"></a>2. 升级GitLab</h3><p>GitLab 升级包下载地址：<code>https://packages.gitlab.com/gitlab/gitlab-ce</code>。下载好需要的版本上传至服务器，直接运行下列命令安装就可以了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -Uvh gitlab-ce-10.0.4-ce.0.el7.x86_64.rpm</span><br></pre></td></tr></table></figure><h3 id="3-重新配置GitLab"><a href="#3-重新配置GitLab" class="headerlink" title="3. 重新配置GitLab"></a>3. 重新配置GitLab</h3><p>安装完成后，根据需要修改配置文件<code>/etc/gitlab/gitlab.rb</code>，也可以直接使用原来备份好的<code>gitlab.rb</code>文件，执行重新配置命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure><h3 id="4-重启GitLab"><a href="#4-重启GitLab" class="headerlink" title="4. 重启GitLab"></a>4. 重启GitLab</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl restart</span><br></pre></td></tr></table></figure><h2 id="GitLab数据迁移"><a href="#GitLab数据迁移" class="headerlink" title="GitLab数据迁移"></a>GitLab数据迁移</h2><p>GitLab数据迁移过程参照GitLab数据备份与恢复步骤操作就好了。</p><h5 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h5><p><a href="https://gitlab.com/help/raketasks/backup_restore.md" target="_blank" rel="noopener">https://gitlab.com/help/raketasks/backup_restore.md</a><br><a href="https://blog.csdn.net/ouyang_peng/article/details/77070977" target="_blank" rel="noopener">https://blog.csdn.net/ouyang_peng/article/details/77070977</a></p><h4 id="实验命令"><a href="#实验命令" class="headerlink" title="实验命令"></a>实验命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /apps/data/gitlab/config /apps/data/gitlab/logs  /apps/data/gitlab/data</span><br><span class="line"></span><br><span class="line">docker run --detach \</span><br><span class="line">  --hostname 10.16.91.115 \</span><br><span class="line">  --publish 443:443 --publish 80:80 --publish 22222:22 \</span><br><span class="line">  --name gitlab \</span><br><span class="line">  --restart always \</span><br><span class="line">  --volume /apps/data/gitlab/config:/etc/gitlab \</span><br><span class="line">  --volume /apps/data/gitlab/logs:/var/log/gitlab \</span><br><span class="line">  --volume /apps/data/gitlab/data:/var/opt/gitlab \</span><br><span class="line">  gitlab/gitlab-ce:9.0.0-ce.0</span><br></pre></td></tr></table></figure><p>查看GitLab版本的两个方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /opt/gitlab/embedded/service/gitlab-rails/VERSION</span><br><span class="line"></span><br><span class="line">sudo gitlab-rake gitlab:env:info</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;不管是GitLab升级还是GitLab数据迁移，在实施之前我都必须要先做好Gitlab数据备份工作。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;我们先来看看如何做GitLab的数据备份与恢复。GitLab自身提供了数据备份和恢复的工具:gitlab-rake,具体使用见下文：&lt;/p&gt;
&lt;h2 id=&quot;GitLab的数据备份与恢复&quot;&gt;&lt;a href=&quot;#GitLab的数据备份与恢复&quot; class=&quot;headerlink&quot; title=&quot;GitLab的数据备份与恢复&quot;&gt;&lt;/a&gt;GitLab的数据备份与恢复&lt;/h2&gt;&lt;p&gt;GitLab自身提供了数据备份和恢复的工具:gitlab-rake,具体使用见下文：&lt;/p&gt;
&lt;h3 id=&quot;GitLab备份配置&quot;&gt;&lt;a href=&quot;#GitLab备份配置&quot; class=&quot;headerlink&quot; title=&quot;GitLab备份配置&quot;&gt;&lt;/a&gt;GitLab备份配置&lt;/h3&gt;&lt;p&gt;GitLab默认的备份目录是：&lt;code&gt;/var/opt/gitlab/backups/&lt;/code&gt;，建议选择一个空间充足的目录进行配置。我们可以通过修改&lt;code&gt;/etc/gitlab/gitlab.rb&lt;/code&gt;文件中的如下内容来调整备份路径:&lt;/p&gt;
    
    </summary>
    
      <category term="GitLab" scheme="http://coder-michael.tk/categories/GitLab/"/>
    
    
      <category term="GitLab" scheme="http://coder-michael.tk/tags/GitLab/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes Yaml Template</title>
    <link href="http://coder-michael.tk/2019/05/05/Kubernetes/Kubernetes-Yaml-Template/"/>
    <id>http://coder-michael.tk/2019/05/05/Kubernetes/Kubernetes-Yaml-Template/</id>
    <published>2019-05-05T09:22:42.000Z</published>
    <updated>2019-05-05T09:31:36.858Z</updated>
    
    <content type="html"><![CDATA[<h2 id="nginx-pod-yaml"><a href="#nginx-pod-yaml" class="headerlink" title="nginx-pod.yaml"></a><code>nginx-pod.yaml</code></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="webapp-rc-yaml"><a href="#webapp-rc-yaml" class="headerlink" title="webapp-rc.yaml"></a><code>webapp-rc.yaml</code></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ReplicationController</span><br><span class="line">metadata:</span><br><span class="line">  name: webapp</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    app: webapp</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: webapp</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: webapp</span><br><span class="line">          image: kubeguide/tomcat-app:v2</span><br><span class="line">          ports:</span><br><span class="line">          - containerPort: 8080</span><br><span class="line">          env:</span><br><span class="line">          - name: MYSQL_SERVICE_HOST</span><br><span class="line">            value: &apos;mysql&apos;</span><br></pre></td></tr></table></figure><h2 id="webapp-svc-yaml"><a href="#webapp-svc-yaml" class="headerlink" title="webapp-svc.yaml"></a><code>webapp-svc.yaml</code></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: mywebapp</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">    - port: 8080</span><br><span class="line">      nodePort: 30001</span><br><span class="line">  selector:</span><br><span class="line">    app: webapp</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;nginx-pod-yaml&quot;&gt;&lt;a href=&quot;#nginx-pod-yaml&quot; class=&quot;headerlink&quot; title=&quot;nginx-pod.yaml&quot;&gt;&lt;/a&gt;&lt;code&gt;nginx-pod.yaml&lt;/code&gt;&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;apiVersion: v1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;kind: Pod&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;metadata:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  name: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spec:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  containers:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  - name: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    image: nginx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    imagePullPolicy: IfNotPresent&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ports:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - containerPort: 80&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="Kubernetes" scheme="http://coder-michael.tk/categories/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://coder-michael.tk/tags/Kubernetes/"/>
    
      <category term="Template" scheme="http://coder-michael.tk/tags/Template/"/>
    
  </entry>
  
</feed>
